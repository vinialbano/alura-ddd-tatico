openapi: 3.0.3
info:
  title: Order Cancellation API
  description: API endpoint for cancelling orders with required reason
  version: 1.0.0
  contact:
    name: Orders Bounded Context

servers:
  - url: http://localhost:3000
    description: Development server

paths:
  /orders/{orderId}/cancel:
    post:
      summary: Cancel an order with reason
      description: |
        Cancels an order that is in a cancellable state (AwaitingPayment or Paid) with a required reason.
        Transitions order to Cancelled state and raises OrderCancelled domain event.

        **State Machine Rules:**
        - Orders in AwaitingPayment can be cancelled (customer changes mind)
        - Orders in Paid can be cancelled (refund scenario - actual refund processing is separate)
        - Orders already in Cancelled state cannot be cancelled again
        - Cancellation reason is mandatory and must be substantive (1-500 characters)

        **Performance:**
        - Target: < 1 second (no external gateway involved)

      operationId: cancelOrder
      tags:
        - Orders
        - Cancellation

      parameters:
        - name: orderId
          in: path
          required: true
          description: UUID of the order to cancel
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"

      requestBody:
        description: Cancellation request with mandatory reason
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelOrderRequest'
            examples:
              customerChangedMind:
                summary: Customer changed mind
                value:
                  reason: "Customer changed mind"
              itemOutOfStock:
                summary: Item out of stock (customer service initiated)
                value:
                  reason: "Item out of stock"
              incorrectAddress:
                summary: Incorrect shipping address
                value:
                  reason: "Incorrect shipping address - customer requested correction"

      responses:
        '200':
          description: Order cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
              examples:
                cancelledFromAwaitingPayment:
                  summary: Cancelled from AwaitingPayment
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    customerId: "customer-123"
                    status: "Cancelled"
                    totalAmount:
                      amount: 100.00
                      currency: "USD"
                    paymentId: null
                    cancellationReason: "Customer changed mind"
                    items:
                      - productSnapshot:
                          name: "Wireless Mouse"
                          description: "Ergonomic wireless mouse"
                          sku: "MOUSE-001"
                        quantity: 2
                        unitPrice:
                          amount: 25.00
                          currency: "USD"
                        itemDiscount:
                          amount: 0.00
                          currency: "USD"
                        lineTotal:
                          amount: 50.00
                          currency: "USD"
                    shippingAddress:
                      street: "123 Main St"
                      city: "San Francisco"
                      state: "CA"
                      postalCode: "94102"
                      country: "USA"
                    orderLevelDiscount:
                      amount: 0.00
                      currency: "USD"
                    createdAt: "2026-01-04T15:00:00Z"
                cancelledFromPaid:
                  summary: Cancelled from Paid (refund scenario)
                  value:
                    id: "660e8400-e29b-41d4-a716-446655440001"
                    customerId: "customer-456"
                    status: "Cancelled"
                    totalAmount:
                      amount: 150.00
                      currency: "USD"
                    paymentId: "PAY-660e8400"
                    cancellationReason: "Item out of stock"
                    items:
                      - productSnapshot:
                          name: "Mechanical Keyboard"
                          description: "RGB mechanical keyboard"
                          sku: "KB-001"
                        quantity: 1
                        unitPrice:
                          amount: 150.00
                          currency: "USD"
                        itemDiscount:
                          amount: 0.00
                          currency: "USD"
                        lineTotal:
                          amount: 150.00
                          currency: "USD"
                    shippingAddress:
                      street: "456 Oak Ave"
                      city: "Seattle"
                      state: "WA"
                      postalCode: "98101"
                      country: "USA"
                    orderLevelDiscount:
                      amount: 0.00
                      currency: "USD"
                    createdAt: "2026-01-04T14:00:00Z"

        '400':
          description: Validation error - invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              examples:
                missingReason:
                  summary: Missing reason field
                  value:
                    statusCode: 400
                    message: ["reason should not be empty", "reason must be a string"]
                    error: "Bad Request"
                reasonTooShort:
                  summary: Reason is empty string
                  value:
                    statusCode: 400
                    message: ["reason must be longer than or equal to 1 characters"]
                    error: "Bad Request"
                reasonTooLong:
                  summary: Reason exceeds 500 characters
                  value:
                    statusCode: 400
                    message: ["reason must be shorter than or equal to 500 characters"]
                    error: "Bad Request"

        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                statusCode: 404
                message: "Order with id '550e8400-e29b-41d4-a716-446655440000' not found"
                error: "Not Found"

        '409':
          description: Order is already cancelled (cannot cancel twice)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                statusCode: 409
                message: "Cannot cancel order: order is in Cancelled state"
                error: "Conflict"
                currentState: "Cancelled"
                originalReason: "Customer changed mind"

        '422':
          description: Validation error - whitespace-only reason or other semantic validation failure
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                statusCode: 422
                message: "Cancellation reason cannot be empty or whitespace-only"
                error: "Unprocessable Entity"

        '500':
          description: Unexpected server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                statusCode: 500
                message: "Internal server error"
                error: "Internal Server Error"

components:
  schemas:
    CancelOrderRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          minLength: 1
          maxLength: 500
          description: |
            Reason for cancelling the order. Must be substantive (not just whitespace).
            Examples: "Customer changed mind", "Item out of stock", "Incorrect shipping address"
          example: "Customer changed mind"

    OrderResponse:
      type: object
      required:
        - id
        - customerId
        - status
        - totalAmount
        - items
        - shippingAddress
        - orderLevelDiscount
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique order identifier
        customerId:
          type: string
          description: Customer who owns the order
        status:
          type: string
          enum: [AwaitingPayment, Paid, Cancelled]
          description: Current order state
        totalAmount:
          $ref: '#/components/schemas/Money'
        paymentId:
          type: string
          nullable: true
          description: Payment transaction ID (null if not paid, preserved after cancellation)
          example: "PAY-550e8400"
        cancellationReason:
          type: string
          nullable: true
          description: Cancellation reason (populated when status is Cancelled)
          maxLength: 500
          example: "Customer changed mind"
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
          minItems: 1
        shippingAddress:
          $ref: '#/components/schemas/ShippingAddress'
        orderLevelDiscount:
          $ref: '#/components/schemas/Money'
        createdAt:
          type: string
          format: date-time
          description: Order creation timestamp (ISO 8601)

    OrderItem:
      type: object
      required:
        - productSnapshot
        - quantity
        - unitPrice
        - itemDiscount
        - lineTotal
      properties:
        productSnapshot:
          $ref: '#/components/schemas/ProductSnapshot'
        quantity:
          type: integer
          minimum: 1
          description: Quantity ordered
        unitPrice:
          $ref: '#/components/schemas/Money'
        itemDiscount:
          $ref: '#/components/schemas/Money'
          description: Item-level discount (product promotions)
        lineTotal:
          $ref: '#/components/schemas/Money'
          description: Unit price Ã— quantity

    ProductSnapshot:
      type: object
      required:
        - name
        - description
        - sku
      properties:
        name:
          type: string
          description: Product name at time of order
        description:
          type: string
          description: Product description at time of order
        sku:
          type: string
          description: Product SKU at time of order

    Money:
      type: object
      required:
        - amount
        - currency
      properties:
        amount:
          type: number
          format: double
          minimum: 0
          description: Monetary amount
          example: 100.00
        currency:
          type: string
          pattern: '^[A-Z]{3}$'
          description: ISO 4217 3-letter currency code
          example: "USD"

    ShippingAddress:
      type: object
      required:
        - street
        - city
        - state
        - postalCode
        - country
      properties:
        street:
          type: string
          description: Street address
        city:
          type: string
          description: City
        state:
          type: string
          description: State/province
        postalCode:
          type: string
          description: Postal code
        country:
          type: string
          description: Country

    ErrorResponse:
      type: object
      required:
        - statusCode
        - message
        - error
      properties:
        statusCode:
          type: integer
          description: HTTP status code
        message:
          type: string
          description: Error message
        error:
          type: string
          description: Error type
        currentState:
          type: string
          description: Current order state (included for 409 errors)
        originalReason:
          type: string
          description: Original cancellation reason (included for 409 when already cancelled)

    ValidationErrorResponse:
      type: object
      required:
        - statusCode
        - message
        - error
      properties:
        statusCode:
          type: integer
          example: 400
        message:
          type: array
          items:
            type: string
          description: Array of validation error messages from class-validator
        error:
          type: string
          example: "Bad Request"
