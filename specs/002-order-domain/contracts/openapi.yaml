openapi: 3.0.3
info:
  title: Order Domain API
  description: |
    Order management API for the Orders bounded context in the e-commerce system.
    Handles checkout, order lifecycle management (payment, cancellation), and order retrieval.

    Part of Stage 2 implementation: Domain Services & Gateways with synchronous external integration.
  version: 1.0.0
  contact:
    name: Orders Team
    email: orders@example.com

servers:
  - url: http://localhost:3000
    description: Local development server
  - url: http://localhost:3000/api
    description: Local development with API prefix

tags:
  - name: Orders
    description: Order lifecycle management operations
  - name: Checkout
    description: Shopping cart to order conversion

paths:
  /orders/checkout:
    post:
      tags:
        - Checkout
      summary: Create order from shopping cart
      description: |
        Converts a shopping cart into an order with captured product snapshots and pricing.

        **Process**:
        1. Validates cart exists and is not empty
        2. Validates cart has not already been converted
        3. Retrieves product data for snapshots (via Product Catalog context)
        4. Calculates pricing, discounts, totals (via Pricing context)
        5. Creates Order aggregate in AwaitingPayment state
        6. Marks cart as converted

        **Idempotency**: If cart already converted, returns existing order instead of error.

        **Timeout**: 2 seconds for external service calls. Fails immediately if timeout exceeded.
      operationId: checkoutCart
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckoutRequest'
            examples:
              valid:
                summary: Valid checkout request
                value:
                  cartId: 'c7f8a3b2-1234-5678-9abc-def012345678'
                  shippingAddress:
                    street: '123 Main Street'
                    addressLine2: 'Apt 4B'
                    city: 'Springfield'
                    stateOrProvince: 'Illinois'
                    postalCode: '62701'
                    country: 'USA'
                    deliveryInstructions: 'Ring doorbell twice'
      responses:
        '201':
          description: Order created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
              examples:
                awaitingPayment:
                  summary: Newly created order
                  value:
                    id: 'f3d9e4a1-5678-9abc-def0-123456789abc'
                    cartId: 'c7f8a3b2-1234-5678-9abc-def012345678'
                    customerId: 'u4e2b8c6-9012-3456-789a-bcdef0123456'
                    status: 'AWAITING_PAYMENT'
                    items:
                      - productSnapshot:
                          name: 'Premium Coffee Beans'
                          description: 'Single-origin Arabica beans from Colombia'
                          sku: 'COFFEE-COL-001'
                        quantity: 2
                        unitPrice:
                          amount: 24.99
                          currency: 'USD'
                        itemDiscount:
                          amount: 0.00
                          currency: 'USD'
                        lineTotal:
                          amount: 49.98
                          currency: 'USD'
                    shippingAddress:
                      street: '123 Main Street'
                      addressLine2: 'Apt 4B'
                      city: 'Springfield'
                      stateOrProvince: 'Illinois'
                      postalCode: '62701'
                      country: 'USA'
                      deliveryInstructions: 'Ring doorbell twice'
                    orderLevelDiscount:
                      amount: 5.00
                      currency: 'USD'
                    totalAmount:
                      amount: 44.98
                      currency: 'USD'
                    paymentId: null
                    cancellationReason: null
                    createdAt: '2025-12-28T10:30:00Z'
        '200':
          description: Cart already converted, returning existing order (idempotent)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Bad request - validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                emptyCart:
                  summary: Empty cart
                  value:
                    statusCode: 400
                    message: 'Cannot checkout empty cart'
                    error: 'Bad Request'
                invalidAddress:
                  summary: Invalid shipping address
                  value:
                    statusCode: 400
                    message: 'Shipping address missing required field: postalCode'
                    error: 'Bad Request'
                pricingFailed:
                  summary: Pricing calculation failed
                  value:
                    statusCode: 400
                    message: 'Cannot price product: COFFEE-COL-001'
                    error: 'Bad Request'
        '404':
          description: Cart not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                cartNotFound:
                  summary: Cart does not exist
                  value:
                    statusCode: 404
                    message: 'Cart not found: c7f8a3b2-1234-5678-9abc-def012345678'
                    error: 'Not Found'
        '500':
          description: Internal server error or external service failure
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                catalogTimeout:
                  summary: Product catalog timeout
                  value:
                    statusCode: 500
                    message: 'Product data unavailable: timeout after 2 seconds'
                    error: 'Internal Server Error'
                pricingTimeout:
                  summary: Pricing service timeout
                  value:
                    statusCode: 500
                    message: 'Pricing calculation unavailable: timeout after 2 seconds'
                    error: 'Internal Server Error'

  /orders/{orderId}:
    get:
      tags:
        - Orders
      summary: Get order by ID
      description: Retrieves complete order details including items, pricing, and status.
      operationId: getOrderById
      parameters:
        - name: orderId
          in: path
          required: true
          description: Unique order identifier (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Order found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /orders/{orderId}/mark-paid:
    post:
      tags:
        - Orders
      summary: Mark order as paid
      description: |
        Transitions order from AwaitingPayment to Paid state with payment transaction ID.

        **State Machine Rules**:
        - Only orders in AwaitingPayment state can be marked as paid
        - Paid orders cannot be paid again
        - Cancelled orders cannot be paid

        **Input**: Payment transaction ID from payment system
      operationId: markOrderAsPaid
      parameters:
        - name: orderId
          in: path
          required: true
          description: Unique order identifier (UUID)
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MarkPaidRequest'
            examples:
              valid:
                summary: Valid payment marking
                value:
                  paymentId: 'pay_abc123def456ghi789'
      responses:
        '200':
          description: Order marked as paid successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
              examples:
                paid:
                  summary: Order now paid
                  value:
                    id: 'f3d9e4a1-5678-9abc-def0-123456789abc'
                    cartId: 'c7f8a3b2-1234-5678-9abc-def012345678'
                    customerId: 'u4e2b8c6-9012-3456-789a-bcdef0123456'
                    status: 'PAID'
                    items: []
                    shippingAddress: {}
                    orderLevelDiscount:
                      amount: 5.00
                      currency: 'USD'
                    totalAmount:
                      amount: 44.98
                      currency: 'USD'
                    paymentId: 'pay_abc123def456ghi789'
                    cancellationReason: null
                    createdAt: '2025-12-28T10:30:00Z'
        '400':
          description: Invalid state transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                alreadyPaid:
                  summary: Order already paid
                  value:
                    statusCode: 400
                    message: 'Cannot mark order as paid: order is already in Paid state'
                    error: 'Bad Request'
                cancelled:
                  summary: Order cancelled
                  value:
                    statusCode: 400
                    message: 'Cannot mark order as paid: order is in Cancelled state'
                    error: 'Bad Request'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /orders/{orderId}/cancel:
    post:
      tags:
        - Orders
      summary: Cancel order
      description: |
        Transitions order to Cancelled state with cancellation reason.

        **State Machine Rules**:
        - Orders in AwaitingPayment can be cancelled
        - Orders in Paid can be cancelled (refund scenario)
        - Cancelled orders cannot be cancelled again

        **Input**: Cancellation reason explaining why order is being cancelled
      operationId: cancelOrder
      parameters:
        - name: orderId
          in: path
          required: true
          description: Unique order identifier (UUID)
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelOrderRequest'
            examples:
              customerRequest:
                summary: Customer requested cancellation
                value:
                  reason: 'Customer changed mind'
              refund:
                summary: Refund after payment
                value:
                  reason: 'Customer requested refund'
      responses:
        '200':
          description: Order cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
              examples:
                cancelled:
                  summary: Order now cancelled
                  value:
                    id: 'f3d9e4a1-5678-9abc-def0-123456789abc'
                    cartId: 'c7f8a3b2-1234-5678-9abc-def012345678'
                    customerId: 'u4e2b8c6-9012-3456-789a-bcdef0123456'
                    status: 'CANCELLED'
                    items: []
                    shippingAddress: {}
                    orderLevelDiscount:
                      amount: 5.00
                      currency: 'USD'
                    totalAmount:
                      amount: 44.98
                      currency: 'USD'
                    paymentId: null
                    cancellationReason: 'Customer changed mind'
                    createdAt: '2025-12-28T10:30:00Z'
        '400':
          description: Invalid state transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                alreadyCancelled:
                  summary: Order already cancelled
                  value:
                    statusCode: 400
                    message: 'Cannot cancel order: order is already in Cancelled state'
                    error: 'Bad Request'
                missingReason:
                  summary: Cancellation reason missing
                  value:
                    statusCode: 400
                    message: 'Cancellation reason is required'
                    error: 'Bad Request'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    CheckoutRequest:
      type: object
      required:
        - cartId
        - shippingAddress
      properties:
        cartId:
          type: string
          format: uuid
          description: Shopping cart identifier to convert into order
          example: 'c7f8a3b2-1234-5678-9abc-def012345678'
        shippingAddress:
          $ref: '#/components/schemas/ShippingAddress'

    MarkPaidRequest:
      type: object
      required:
        - paymentId
      properties:
        paymentId:
          type: string
          minLength: 1
          description: Payment transaction identifier from payment system
          example: 'pay_abc123def456ghi789'

    CancelOrderRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          minLength: 1
          maxLength: 500
          description: Explanation for order cancellation
          example: 'Customer changed mind'

    OrderResponse:
      type: object
      required:
        - id
        - cartId
        - customerId
        - status
        - items
        - shippingAddress
        - orderLevelDiscount
        - totalAmount
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique order identifier
          example: 'f3d9e4a1-5678-9abc-def0-123456789abc'
        cartId:
          type: string
          format: uuid
          description: Source shopping cart identifier
          example: 'c7f8a3b2-1234-5678-9abc-def012345678'
        customerId:
          type: string
          format: uuid
          description: Customer who created the order
          example: 'u4e2b8c6-9012-3456-789a-bcdef0123456'
        status:
          type: string
          enum: [AWAITING_PAYMENT, PAID, CANCELLED]
          description: Current order state
          example: 'AWAITING_PAYMENT'
        items:
          type: array
          minItems: 1
          description: Order line items with captured product data and pricing
          items:
            $ref: '#/components/schemas/OrderItem'
        shippingAddress:
          $ref: '#/components/schemas/ShippingAddress'
        orderLevelDiscount:
          $ref: '#/components/schemas/Money'
          description: Cart-wide discount applied (zero if no discount)
        totalAmount:
          $ref: '#/components/schemas/Money'
          description: Total order amount after all discounts
        paymentId:
          type: string
          nullable: true
          description: Payment transaction ID (set when order is paid)
          example: 'pay_abc123def456ghi789'
        cancellationReason:
          type: string
          nullable: true
          description: Reason for cancellation (set when order is cancelled)
          example: 'Customer changed mind'
        createdAt:
          type: string
          format: date-time
          description: Order creation timestamp (ISO 8601)
          example: '2025-12-28T10:30:00Z'

    OrderItem:
      type: object
      required:
        - productSnapshot
        - quantity
        - unitPrice
        - itemDiscount
        - lineTotal
      properties:
        productSnapshot:
          $ref: '#/components/schemas/ProductSnapshot'
        quantity:
          type: integer
          minimum: 1
          description: Number of units ordered
          example: 2
        unitPrice:
          $ref: '#/components/schemas/Money'
          description: Price per unit at checkout time
        itemDiscount:
          $ref: '#/components/schemas/Money'
          description: Product-level discount applied (zero if no discount)
        lineTotal:
          $ref: '#/components/schemas/Money'
          description: Total for this line item (unitPrice Ã— quantity - itemDiscount)

    ProductSnapshot:
      type: object
      required:
        - name
        - description
        - sku
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
          description: Product name at checkout time
          example: 'Premium Coffee Beans'
        description:
          type: string
          minLength: 1
          maxLength: 1000
          description: Product description at checkout time
          example: 'Single-origin Arabica beans from Colombia, medium roast'
        sku:
          type: string
          minLength: 1
          maxLength: 50
          description: Stock Keeping Unit identifier
          example: 'COFFEE-COL-001'

    ShippingAddress:
      type: object
      required:
        - street
        - city
        - stateOrProvince
        - postalCode
        - country
      properties:
        street:
          type: string
          minLength: 1
          maxLength: 200
          description: Street address (line 1)
          example: '123 Main Street'
        addressLine2:
          type: string
          maxLength: 200
          nullable: true
          description: Apartment, suite, unit, etc. (optional)
          example: 'Apt 4B'
        city:
          type: string
          minLength: 1
          maxLength: 100
          description: City name
          example: 'Springfield'
        stateOrProvince:
          type: string
          minLength: 1
          maxLength: 100
          description: State, province, or region
          example: 'Illinois'
        postalCode:
          type: string
          minLength: 1
          maxLength: 20
          description: Postal or ZIP code
          example: '62701'
        country:
          type: string
          minLength: 2
          maxLength: 100
          description: Country name or ISO code
          example: 'USA'
        deliveryInstructions:
          type: string
          maxLength: 500
          nullable: true
          description: Optional delivery notes
          example: 'Ring doorbell twice'

    Money:
      type: object
      required:
        - amount
        - currency
      properties:
        amount:
          type: number
          format: decimal
          minimum: 0
          multipleOf: 0.01
          description: Monetary amount (2 decimal places)
          example: 24.99
        currency:
          type: string
          minLength: 3
          maxLength: 3
          pattern: '^[A-Z]{3}$'
          description: ISO 4217 currency code (3 uppercase letters)
          example: 'USD'

    ErrorResponse:
      type: object
      required:
        - statusCode
        - message
        - error
      properties:
        statusCode:
          type: integer
          description: HTTP status code
          example: 400
        message:
          type: string
          description: Human-readable error message
          example: 'Cannot checkout empty cart'
        error:
          type: string
          description: Error type
          example: 'Bad Request'
